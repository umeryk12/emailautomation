{% extends "base.html" %}

{% block title %}Dashboard - Email Automation{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-0">
            <i class="fas fa-tachometer-alt text-primary me-2"></i>Dashboard
        </h1>
        <p class="text-muted">Welcome, {{ current_user.username }}! Start your email campaign.</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ campaigns|length }}</div>
            <div class="stat-label">Total Campaigns</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ templates|length }}</div>
            <div class="stat-label">Email Templates</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="total-sent">0</div>
            <div class="stat-label">Emails Sent</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="active-campaigns">0</div>
            <div class="stat-label">Active Campaigns</div>
        </div>
    </div>
</div>

<!-- Start New Campaign -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Start New Campaign</h5>
            </div>
            <div class="card-body">
                <div id="campaign-alert"></div>
                <form id="campaignForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email_list_type" class="form-label">Email List</label>
                            <select class="form-select" id="email_list_type" name="email_list_type" required>
                                <option value="">Choose an email list...</option>
                                <option value="yc_startups">YC Startups</option>
                                <option value="business_emails">Business Emails</option>
                                <option value="gr">GR (Greece) Emails</option>
                            </select>
                            <small class="text-muted">Select the target audience for your campaign</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="template_id" class="form-label">Email Template</label>
                            <select class="form-select" id="template_id" name="template_id">
                                <option value="">Use Default Template</option>
                                {% for template in templates %}
                                <option value="{{ template.id }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Choose a template or use default</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Start Campaign
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Templates Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Email Templates</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#templateModal">
                    <i class="fas fa-plus me-1"></i>New Template
                </button>
            </div>
            <div class="card-body">
                {% if templates %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for template in templates %}
                            <tr>
                                <td>
                                    {{ template.name }}
                                    {% if template.is_default %}
                                    <span class="badge bg-primary">Default</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ template.subject_template[:50] }}...</small></td>
                                <td><small>{{ template.created_at.strftime('%Y-%m-%d') }}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewTemplate({{ template.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate({{ template.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No templates yet. Create your first template!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Template -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Template File</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="template_file" class="form-label">Template File (.txt)</label>
                        <input type="file" class="form-control" id="template_file" name="file" accept=".txt" required>
                        <small class="text-muted">Upload a text file with your email template. First line can be "Subject: ..."</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Template
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Campaigns List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Recent Campaigns</h5>
            </div>
            <div class="card-body">
                {% if campaigns %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="campaigns-table">
                            {% for campaign in campaigns %}
                            <tr>
                                <td>{{ campaign.name }}</td>
                                <td><span class="badge bg-info">{{ campaign.email_list_type }}</span></td>
                                <td>
                                    {% if campaign.status == 'completed' %}
                                    <span class="badge bg-success">{{ campaign.status }}</span>
                                    {% elif campaign.status == 'running' %}
                                    <span class="badge bg-warning">{{ campaign.status }}</span>
                                    {% elif campaign.status == 'failed' %}
                                    <span class="badge bg-danger">{{ campaign.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ campaign.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if campaign.total_emails > 0 %}
                                    {{ campaign.sent_emails }}/{{ campaign.total_emails }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td><small>{{ campaign.created_at.strftime('%Y-%m-%d %H:%M') }}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewCampaign({{ campaign.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No campaigns yet. Start your first campaign above!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newTemplateForm">
                    <div class="mb-3">
                        <label for="template_name" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="template_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="subject_template" class="form-label">Subject Template</label>
                        <input type="text" class="form-control" id="subject_template" 
                               value="Partnership Opportunity - {company_name}" required>
                        <small class="text-muted">Use {company_name}, {founder_name}, etc. as placeholders</small>
                    </div>
                    <div class="mb-3">
                        <label for="template_content" class="form-label">Email Content</label>
                        <textarea class="form-control" id="template_content" rows="15" required></textarea>
                        <small class="text-muted">Use {company_name}, {founder_name}, {industry}, {sender_name} as placeholders</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load campaign stats
    updateStats();
    setInterval(updateStats, 5000); // Update every 5 seconds
    
    // Campaign form
    $('#campaignForm').on('submit', function(e) {
        e.preventDefault();
        const formData = {
            email_list_type: $('#email_list_type').val(),
            template_id: $('#template_id').val() || null
        };
        
        if (!formData.email_list_type) {
            showAlert('campaign-alert', 'danger', 'Please select an email list');
            return;
        }
        
        const btn = $(this).find('button[type="submit"]');
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Starting...');
        
        $.ajax({
            url: '/api/campaigns',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showAlert('campaign-alert', 'success', 'Campaign started successfully!');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('campaign-alert', 'danger', response.message || 'Failed to start campaign');
                    btn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert('campaign-alert', 'danger', response?.message || 'An error occurred');
                btn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // Upload template
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const btn = $(this).find('button[type="submit"]');
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Uploading...');
        
        $.ajax({
            url: '/api/upload-template',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showAlert('campaign-alert', 'success', 'Template uploaded successfully!');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('campaign-alert', 'danger', response.message || 'Upload failed');
                    btn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert('campaign-alert', 'danger', response?.message || 'Upload failed');
                btn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // New template form
    $('#newTemplateForm').on('submit', function(e) {
        e.preventDefault();
        const formData = {
            name: $('#template_name').val(),
            subject_template: $('#subject_template').val(),
            template_content: $('#template_content').val()
        };
        
        $.ajax({
            url: '/api/templates',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    $('#templateModal').modal('hide');
                    location.reload();
                } else {
                    alert(response.message || 'Failed to save template');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert(response?.message || 'An error occurred');
            }
        });
    });
});

function updateStats() {
    $.ajax({
        url: '/api/campaigns',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                let totalSent = 0;
                let activeCount = 0;
                response.campaigns.forEach(c => {
                    totalSent += c.sent_emails || 0;
                    if (c.status === 'running') activeCount++;
                });
                $('#total-sent').text(totalSent);
                $('#active-campaigns').text(activeCount);
            }
        }
    });
}

function viewTemplate(id) {
    // TODO: Implement template view
    alert('Template view coming soon!');
}

function deleteTemplate(id) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    $.ajax({
        url: `/api/templates/${id}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                location.reload();
            }
        }
    });
}

function viewCampaign(id) {
    $.ajax({
        url: `/api/campaigns/${id}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const c = response.campaign;
                alert(`Campaign: ${c.name}\nStatus: ${c.status}\nSent: ${c.sent_emails}/${c.total_emails}\nFailed: ${c.failed_emails}`);
            }
        }
    });
}

function showAlert(container, type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $(`#${container}`).html(alertHtml);
}
</script>
{% endblock %}

